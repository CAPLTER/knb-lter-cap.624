---
title: "knb-lter-cap.624"
output: html_document
---

# README

## knb-lter-cap.624.3

* workflow updated to capeml featuring config.yaml
* pH included with runoff_chemistry; temperature not included owing to the
  inherent meaningless of that measurement in this context; salinity and TDS
  (meter) not included owing to very scant values for those measurements; pH
  not recorded on rain samples
* improved location description
* locations from table to kml

## knb-lter-cap.624.2

This version 624.2 is a new workflow based on the Rmd format. There are new
data available but, in the interest of time for the review, only data currently
in the database at the time of construction are going into this version 2. More
recent data and the discharge project stuff at the Salt River sites need to go
into a version 3 soon.

Note that this new workflow if pretty-much hit the button and everything should
be built. Still not addressed at in this current configuration, however, are
the keyword attributes, so those still have to be done by hand. Note also that
the kml file is going to be overwritten every time.

# libraries

```{r libraries}
library(EML)
library(tidyverse)
library(capeml)
```

# runoff chemistry

- Data from 2007 include only a single storm at IBW; these are omitted owing to
  lack of collection times

```{r runoff-chemistry}

runoffChemistry <- dbGetQuery(pg, '
SELECT
  s.bottle,
  sites.abbreviation AS runoff_location,
  s.sample_datetime AS runoff_datetime,
  s.comments AS sample_comments,
  s."lab_pH" AS pH,
  r.replicate,
  a.analysis_name,
  r.concentration AS analysis_concentration,
  dq.data_qualifier_label AS analysis_data_qualifier,
  r.comments AS analysis_comments
FROM
  stormwater.samples s
  LEFT JOIN stormwater.results r ON (r.sample_id = s.sample_id)
  JOIN stormwater.analysis a ON (r.analysis_id = a.analysis_id)
  JOIN stormwater.sites ON (s.site_id = sites.site_id)
  LEFT JOIN stormwater.data_qualifier dq ON (dq.data_qualifier_id = r.data_qualifier)
WHERE
  EXTRACT (YEAR FROM s.sample_datetime) > 2007 AND
  -- r.analysis_id IS NOT NULL AND
  (bottle NOT ILIKE \'%rain%\' OR bottle IS NULL)
;
')

runoff_chemistry <- runoffChemistry %>%
  mutate(
    blank = as.factor(ifelse(grepl("blk|blank", bottle, ignore.case = T), "TRUE", "FALSE")),
    runoff_location = as.factor(runoff_location),
    analysis_name = as.factor(analysis_name)
    ) %>%
select(
  runoff_location,
  runoff_datetime,
  blank,
  everything(),
  -bottle
  ) %>%
arrange(
  runoff_location,
  analysis_name,
  runoff_datetime
)

# write_attributes(runoff_chemistry)
# write_factors(runoff_chemistry)

runoff_chemistry_desc <- "stormwater runoff chemistry during runoff-generating storms at CAP LTER stormwater sampling sites"

runoff_chemistry_DT <- create_dataTable(
  dfname = runoff_chemistry,
  description = runoff_chemistry_desc,
  dateRangeField = "runoff_datetime"
)

```

# rainfall chemistry

```{r rainfall-chemistry}

rainfallChemistry <- dbGetQuery(pg, "
SELECT
  sites.abbreviation AS rain_location,
  s.sample_datetime AS rain_datetime,
  r.replicate,
  a.analysis_name AS analysis,
  r.concentration,
  dq.data_qualifier_label AS data_qualifier,
  r.comments
FROM
  stormwater.results r
  JOIN stormwater.samples s ON (s.sample_id = r.sample_id)
  JOIN stormwater.analysis a ON (r.analysis_id = a.analysis_id)
  JOIN stormwater.sites ON (s.site_id = sites.site_id)
  LEFT JOIN stormwater.data_qualifier dq ON (dq.data_qualifier_id = r.data_qualifier)
WHERE
  EXTRACT (YEAR FROM s.sample_datetime) > 2007 AND
  r.analysis_id IS NOT NULL AND
  bottle ILIKE '%rain%'
ORDER BY
  sites.abbreviation,
  s.sample_datetime,
  a.analysis_name
;")

rainfall_chemistry <- rainfallChemistry %>%
  mutate(
    rain_location = as.factor(rain_location),
    analysis = as.factor(analysis),
    rain_datetime = as.Date(rain_datetime)
  )

# write_attributes(rainfall_chemistry)
# write_factors(rainfall_chemistry)

rainfall_chemistry_desc <- "water chemistry of collected rainfall at CAP LTER stormwater sampling sites"

rainfall_chemistry_DT <- create_dataTable(
  dfname = rainfall_chemistry,
  description = rainfall_chemistry_desc,
  dateRangeField = "rain_datetime")

```

# rainfail

```{r rainfall}

rainfall <- dbGetQuery(pg, "
SELECT
  sites.abbreviation AS rain_location,
  r.event_datetime AS rain_datetime,
  r.rainfall_quantity AS rain_quantity
FROM
  stormwater.rainfall r
  JOIN stormwater.sites ON (r.site_id = sites.site_id);")

rainfall <- rainfall %>%
  mutate(
    rain_location = as.factor(rain_location)
  )

rainfall_desc <- "depth of precipitation as measured by tipping bucket rain gauge at CAP LTER stormwater sampling sites"

rainfall_DT <- create_dataTable(
  dfname = rainfall,
  description = rainfall_desc,
  dateRangeField = "rain_datetime")

```

# discharge

```{r discharge}

discharge <- dbGetQuery(pg, "
SELECT
  sites.abbreviation AS discharge_location,
  r.event_datetime AS discharge_datetime,
  r.water_height AS water_height,
  r.discharge AS raw_discharge,
  r.discharge_corrected AS edited_discharge
FROM
  stormwater.discharge r
  JOIN stormwater.sites ON (r.site_id = sites.site_id)
;")

discharge <- discharge %>%
  mutate(
    discharge_location = as.factor(discharge_location)
  )

discharge_desc <- "discharge at CAP LTER stormwater sampling sites"

discharge_DT <- create_dataTable(
  dfname = discharge,
  description = discharge_desc,
  dateRangeField = "discharge_datetime")

```

# particulates

```{r particulates}

particulates <- dbGetQuery(pg, "
SELECT
  s.bottle,
  sites.abbreviation AS runoff_location,
  s.sample_datetime AS runoff_datetime,
  r.replicate AS replicate,
  r.filter_initial AS filter_wt,
  r.filter_dry AS filter_dry_wt,
  r.volume_filtered AS vol_filtered,
  r.filter_ashed AS filter_ash_wt,
  r.data_qualifier AS data_qualifier,
  r.comments AS comments
FROM
  stormwater.solids r
  JOIN stormwater.samples s ON (s.sample_id = r.sample_id)
  JOIN stormwater.sites ON (s.site_id = sites.site_id)
  LEFT JOIN stormwater.data_qualifier dq ON (dq.data_qualifier_id = r.data_qualifier);")

particulates <- particulates %>%
  mutate(
    blank = as.factor(ifelse(grepl("blk|blank", bottle, ignore.case = T), "TRUE", "FALSE")),
    runoff_location = as.factor(runoff_location),
    data_qualifier = as.character(data_qualifier)
  ) %>%
  select(-bottle)

particulates_desc <- "mass of particulates in stormwater during runoff-generating storms at CAP LTER stormwater sampling sites"

particulates_DT <- create_dataTable(
  dfname = particulates,
  description = particulates_desc,
  dateRangeField = "runoff_datetime")

```

# sampling_location

```{r sampling-location, eval=TRUE}

library(sf)
library(capemlGIS)

sampling_location <- dbGetQuery(pg, "
  SELECT
  abbreviation AS location_identifier,
  site_name AS location_description,
  latitude,
  longitude
  FROM
  stormwater.sites;") %>%
  mutate(
    Name = location_identifier,
    description = location_description
    ) %>%
  select(
    -location_identifier,
    -location_description
  )

  # write_attributes(sampling_location)

sampling_location <- sampling_location %>%
  st_as_sf(
    coords = c("longitude", "latitude"),
    crs = 4326
  )

sampling_location_desc <- "CAP LTER stormwater sampling locations"

sampling_location_SV <- create_spatialVector(
  svname = sampling_location,
  description = sampling_location_desc
)

```

# analyses

```{r analyses}

analytes <- dbGetQuery(pg,"
SELECT
  DISTINCT ON (analysis_name)
  analysis_name as analysis,
  analysis_description AS description,
  units,
  instrument
FROM
  stormwater.analysis
  RIGHT JOIN stormwater.results r ON (r.analysis_id = analysis.analysis_id)
WHERE
  analysis_name IS NOT NULL;")

analytes_desc <- "catalog and details of water chemistry analytes measured as part of CAP LTER stormwater monitoring"

analytes_DT <- create_dataTable(
  dfname = analytes,
  description = analytes_desc)

```

# indian_bend_wash_catchments

Here we keep the source file (stormwater_catchments.kml) in the repository so
that we can easily reconstruct indian_bend_wash_catchments when updating.

```{r indian-bend-wash-catchments, eval=TRUE}

library(sf)
library(capemlGIS)

# load spatial vector object
indian_bend_wash_catchments <- read_sf(
  here::here("stormwater_catchments.kml")
)

# the following are one-time operations and should not need to be repeated

# drop geometry before writing attributes
# indian_bend_wash_catchments <- indian_bend_wash_catchments %>%
#   st_drop_geometry()

# write_attributes(indian_bend_wash_catchments)

# re-load spatial vector object
# indian_bend_wash_catchments <- read_sf(
#   here::here("stormwater_catchments.kml")
# )

indian_bend_wash_catchments_desc <- "The location and configuration of watersheds that are or have been sampled as part of the CAP LTER's research on stormwater monitoring in the greater Phoenix metropolitan area. Catchments for sampling locations along the Salt River (centralNorth, centralSouth, Ave7th) and Price have not been delineated by the CAP LTER."

indian_bend_wash_catchments_SV <- create_spatialVector(
  svname = indian_bend_wash_catchments,
  description = indian_bend_wash_catchments_desc
)

```


# people

```{r people}

library(gioseml)

# creators

dan <- create_role(
  firstName = "dan",
  lastName = "childers",
  roleType = "creator")
stevan <- create_role(
  firstName = "ste",
  lastName = "earl",
  roleType = "creator")
nancy <- create_role(
  firstName = "nan",
  lastName = "grimm",
  roleType = "creator")
rebecca <- create_role(
  firstName = "rebe",
  lastName = "hale",
  roleType = "creator")
laura <- create_role(
  firstName = "laura",
  lastName = "turnb",
  roleType = "creator")

creators <- list(
  dan,
  stevan,
  nancy,
  rebecca,
  laura
)


# metadata providers

stevan <- create_role(
  firstName = "ste",
  lastName = "earl",
  roleType = "meta")
quincy <- create_role(
  firstName = "qui",
  lastName = "stewar",
  roleType = "meta")
sally <- create_role(
  firstName = "sally",
  lastName = "wittlin",
  roleType = "meta")

metadataProvider <- list(
  stevan,
  quincy,
  sally
)

```

# coverages

```{r coverages}

begindate <- format(min(runoff_chemistry$runoff_datetime), "%Y-%m-%d")
enddate <- format(max(runoff_chemistry$runoff_datetime), "%Y-%m-%d")
geographicDescription <- "CAP LTER study area"

coverage <- set_coverage(
  begin = begindate,
  end = enddate,
  geographicDescription = geographicDescription,
  west = -112.082, east = -111.865,
  north = +33.6149, south = +33.3745)

```

# dataset

Optionally, provide: scope, abstract, methods, keywords, publication date.
Projects scopes include lter (default), urex, ltreb, and som.

```{r construct-dataset}

dataset <- create_dataset()
```

# add dataTable

```{r dataSet$dataTable}

# add dataTables if relevant

print(ls(pattern = "_DT"))

if (length(ls(pattern = "_DT")) > 0) {

  listOfDataTables <- lapply(ls(pattern = "_DT"), function(DT) { get(DT) } )

  dataset$dataTable  <- listOfDataTables

}

# or add manually
# dataset$dataTable <- list(dataTableOne, dataTableTwo)

```

# add spatialVector

```{r dataSet$spatialVector}

# add spatial vectors if relevant

print(ls(pattern = "_SV"))

if (length(ls(pattern = "_SV")) > 0) {

  listOfSpatialVectors <- lapply(ls(pattern = "_SV"), function(SV) { get(SV) } )

  dataset$spatialVector  <- listOfSpatialVectors

}

# or add manually
# dataset$spatialVector <- list(spatialVectorOne, spatialVectorTwo)

```

# literature cited

```{r literature-cited, eval=TRUE}

grimm_2004 <- create_citation("https://doi.org/10.1029/153GM11")
grimm_2005 <- create_citation("https://doi.org/10.1899/04-027.1")
halea <- create_citation("https://doi.org/10.1021/es501039t")
haleb <- create_citation("https://doi.org/10.1007/s10021-014-9812-2")
roach_2011 <- create_citation("https://doi.org/10.1890/10-1613.1")
roach_2008 <- create_citation("https://doi.org/10.1641/B580808")
walsh <- create_citation("https://doi.org/10.1899/04-028.1")

citations <- list(
  citation = list(
    grimm_2004,
    grimm_2005,
    halea,
    haleb,
    roach_2011,
    roach_2008,
    walsh
  ) # close list of citations
) # close citation

dataset$literatureCited <- citations

```

# customUnits

```{r custom-units, eval=FALSE}

custom_units <- rbind(
  data.frame(
    id = "milligramPerKilogram",
    unitType = "massPerMass",
    parentSI = "gramsPerGram",
    multiplierToSI = 0.000001,
    description = "millgram of element per kilogram of material")
)

unitList <- set_unitList(
  custom_units,
  as_metadata = TRUE)

```

# eml

```{r construct_eml, eval=TRUE}

eml <- create_eml()
```

```{r validate_eml, eval=TRUE}

eml_validate(eml)
```

```{r eml_to_file, eval=TRUE}

# write the eml to file
write_cap_eml()
```

# file placement

```{r package-details, eval=TRUE}

# retrieve package details from config.yaml
if (!file.exists("config.yaml")) {
  stop("config.yaml not found")
}
packageIdent <- yaml::yaml.load_file("config.yaml")$packageIdent
packageNum <- yaml::yaml.load_file("config.yaml")$packageNum
```

```{r preview_data_file_to_upload}

# preview data set files that will be uploaded to S3
list.files(pattern = paste0(packageNum, "_"))
```

Move data and final xml files to respective ASU locations.

```{r S3_helper_functions}
# functions and setting for uploading to S3
library(aws.s3)
source("~/Documents/localSettings/aws.s3")
```

```{r upload_data_S3}

# upload files to S3
lapply(list.files(pattern = paste0(packageNum, "_")), data_to_amz)
```

```{r clean_up}

# remove data files
dataFilesToRemove <- dir(pattern = paste0(packageNum, "_"))
file.remove(dataFilesToRemove)

# EML to S3
eml_to_amz(list.files(pattern = "knb.+xml"))

# EML to cap-data-eml and remove file from project
file.copy(list.files(pattern = "knb.+xml"), "/home/srearl/localRepos/cap-metadata/cap-data-eml/")
file.remove(list.files(pattern = "knb.+xml"))
